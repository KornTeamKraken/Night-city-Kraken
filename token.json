// Installation requise :
// npm install @solana/web3.js @solana/spl-token @metaplex-foundation/mpl-token-metadata

const {
  Connection,
  Keypair,
  PublicKey,
  clusterApiUrl,
  Transaction,
  sendAndConfirmTransaction
} = require('@solana/web3.js');

const {
  createMint,
  getOrCreateAssociatedTokenAccount,
  mintTo,
  setAuthority,
  AuthorityType,
  getMint
} = require('@solana/spl-token');

const {
  Metaplex,
  keypairIdentity,
  bundlrStorage
} = require('@metaplex-foundation/js');

const fs = require('fs');

// ============================================
// CONFIGURATION DU TOKEN KRAKEN
// ============================================
const TOKEN_CONFIG = {
  name: 'Kraken',
  symbol: 'KRK',
  description: 'Token officiel de Kraken City - Ecosystem gaming et rewards',
  decimals: 9,
  totalSupply: 10_000_000, // 10 millions
  
  // MÃ©tadonnÃ©es pour Phantom
  imageUrl: 'https://kraken-city.fr/kraken.png', // URL de votre logo
  externalUrl: 'https://kraken-city.fr',
  
  // Distribution
  distribution: {
    team: { amount: 1_200_000, percent: 12 },      // 12% Ã‰quipe/Dev
    marketing: { amount: 1_000_000, percent: 10 }, // 10% Marketing
    burn: { amount: 800_000, percent: 8 },         // 8% Burn
    events: { amount: 1_000_000, percent: 10 },    // 10% Events/Tournois
    players: { amount: 4_500_000, percent: 45 },   // 45% Joueurs/Rewards
    staking: { amount: 1_500_000, percent: 15 }    // 15% Staking
  }
};

// ============================================
// FONCTION PRINCIPALE
// ============================================
async function createKrakenToken() {
  try {
    console.log('ğŸ™ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('   CRÃ‰ATION DU TOKEN FONGIBLE KRAKEN (SPL)');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    // 1. Connexion au rÃ©seau
    const network = 'mainnet-beta'; // Changez en 'devnet' pour test
    const connection = new Connection(
      clusterApiUrl(network),
      'confirmed'
    );

    console.log(`ğŸŒ RÃ©seau: ${network.toUpperCase()}`);

    // 2. Charger votre wallet Phantom
    console.log('\nğŸ“‚ Chargement du wallet...');
    const payerKeypair = Keypair.fromSecretKey(
      Uint8Array.from(JSON.parse(fs.readFileSync('wallet.json', 'utf-8')))
    );

    console.log('âœ… Wallet chargÃ©:', payerKeypair.publicKey.toString());
    
    // VÃ©rifier le solde
    const balance = await connection.getBalance(payerKeypair.publicKey);
    console.log(`ğŸ’° Solde: ${(balance / 1e9).toFixed(4)} SOL`);

    if (balance < 0.5e9) {
      console.error('\nâŒ Solde insuffisant. Besoin d\'au moins 0.5 SOL pour les frais.');
      console.log('ğŸ’¡ Ajoutez du SOL Ã  votre wallet Phantom et rÃ©essayez.');
      return;
    }

    // 3. CrÃ©er le mint (token)
    console.log('\nğŸ“ CrÃ©ation du token mint...');
    const mint = await createMint(
      connection,
      payerKeypair,
      payerKeypair.publicKey, // mint authority (vous)
      payerKeypair.publicKey, // freeze authority (vous)
      TOKEN_CONFIG.decimals
    );
    
    console.log('âœ… Token mint crÃ©Ã© !');
    console.log('   Address:', mint.toString());

    // 4. CrÃ©er votre compte token principal
    console.log('\nğŸ’³ CrÃ©ation du compte token principal...');
    const tokenAccount = await getOrCreateAssociatedTokenAccount(
      connection,
      payerKeypair,
      mint,
      payerKeypair.publicKey
    );
    
    console.log('âœ… Compte token crÃ©Ã©:', tokenAccount.address.toString());

    // 5. Mint tous les tokens (10 millions)
    console.log('\nğŸ­ Minting de la supply totale...');
    const totalAmount = TOKEN_CONFIG.totalSupply * Math.pow(10, TOKEN_CONFIG.decimals);
    
    await mintTo(
      connection,
      payerKeypair,
      mint,
      tokenAccount.address,
      payerKeypair.publicKey,
      totalAmount
    );
    
    console.log(`âœ… ${TOKEN_CONFIG.totalSupply.toLocaleString()} ${TOKEN_CONFIG.symbol} mintÃ©s !`);

    // 6. Ajouter les mÃ©tadonnÃ©es (pour Phantom)
    console.log('\nğŸ¨ Ajout des mÃ©tadonnÃ©es...');
    
    const metaplex = Metaplex.make(connection)
      .use(keypairIdentity(payerKeypair));

    try {
      const { nft } = await metaplex.nfts().create({
        uri: '', // On va crÃ©er les mÃ©tadonnÃ©es directement
        name: TOKEN_CONFIG.name,
        symbol: TOKEN_CONFIG.symbol,
        sellerFeeBasisPoints: 0,
        useNewMint: mint,
        isMutable: true,
        maxSupply: null, // Token fongible = pas de limite de supply
        tokenStandard: 'Fungible'
      });

      console.log('âœ… MÃ©tadonnÃ©es ajoutÃ©es !');
    } catch (metaError) {
      console.log('âš ï¸  MÃ©tadonnÃ©es: utilisation de mÃ©thode alternative...');
      
      // MÃ©thode alternative avec mpl-token-metadata
      const TOKEN_METADATA_PROGRAM_ID = new PublicKey('metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s');
      
      // Note: Cette partie nÃ©cessiterait le package @metaplex-foundation/mpl-token-metadata
      console.log('ğŸ’¡ Pour afficher dans Phantom, ajoutez votre token manuellement:');
      console.log('   Settings > Manage Token List > Add Custom Token');
    }

    // 7. Afficher le rÃ©sumÃ© de distribution
    console.log('\nğŸ“Š â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('   DISTRIBUTION PRÃ‰VUE DES TOKENS');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
    
    console.log(`Total Supply: ${TOKEN_CONFIG.totalSupply.toLocaleString()} ${TOKEN_CONFIG.symbol}\n`);
    
    for (const [category, data] of Object.entries(TOKEN_CONFIG.distribution)) {
      console.log(
        `${category.padEnd(12)}: ${data.amount.toLocaleString().padStart(10)} ${TOKEN_CONFIG.symbol} (${data.percent}%)`
      );
    }

    // 8. DÃ©sactiver le mint authority (OPTIONNEL - Ã  faire plus tard)
    console.log('\nğŸ” Mint Authority Status:');
    console.log('   âš ï¸  ACTIF - Vous pouvez encore minter des tokens');
    console.log('   ğŸ’¡ Pour fixer la supply dÃ©finitivement, exÃ©cutez:');
    console.log('   node kraken-token-creator.js disable-mint');

    // 9. Sauvegarder les informations
    const tokenInfo = {
      network: network,
      mintAddress: mint.toString(),
      tokenAccount: tokenAccount.address.toString(),
      name: TOKEN_CONFIG.name,
      symbol: TOKEN_CONFIG.symbol,
      decimals: TOKEN_CONFIG.decimals,
      totalSupply: TOKEN_CONFIG.totalSupply,
      distribution: TOKEN_CONFIG.distribution,
      walletAddress: payerKeypair.publicKey.toString(),
      createdAt: new Date().toISOString()
    };

    fs.writeFileSync('kraken-token-info.json', JSON.stringify(tokenInfo, null, 2));

    // 10. Afficher les prochaines Ã©tapes
    console.log('\nğŸ‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('   TOKEN KRAKEN CRÃ‰Ã‰ AVEC SUCCÃˆS !');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
    
    console.log('ğŸ“‹ INFORMATIONS IMPORTANTES:\n');
    console.log(`Mint Address: ${mint.toString()}`);
    console.log(`Votre balance: ${TOKEN_CONFIG.totalSupply.toLocaleString()} ${TOKEN_CONFIG.symbol}`);
    console.log(`Network: ${network}`);
    
    console.log('\nâœ… PROCHAINES Ã‰TAPES:\n');
    console.log('1ï¸âƒ£  Ajouter le token dans Phantom:');
    console.log('   - Ouvrez Phantom');
    console.log('   - Settings > Manage Token List');
    console.log('   - Collez l\'adresse du mint ci-dessus');
    
    console.log('\n2ï¸âƒ£  Distribuer les tokens:');
    console.log('   - Utilisez le script de distribution (Ã  venir)');
    console.log('   - Ou transfÃ©rez manuellement depuis Phantom');
    
    console.log('\n3ï¸âƒ£  CrÃ©er une pool de liquiditÃ©:');
    console.log('   - Raydium: https://raydium.io/');
    console.log('   - Orca: https://www.orca.so/');
    
    console.log('\n4ï¸âƒ£  VÃ©rifier votre token:');
    console.log(`   - Solscan: https://solscan.io/token/${mint.toString()}`);
    console.log(`   - Solana Explorer: https://explorer.solana.com/address/${mint.toString()}`);
    
    console.log('\nğŸ’¾ Informations sauvegardÃ©es dans: kraken-token-info.json');
    console.log('\nğŸ™ Bon lancement avec KRAKEN !\n');

  } catch (error) {
    console.error('\nâŒ ERREUR:', error.message);
    console.error('\nDÃ©tails:', error);
  }
}

// ============================================
// DÃ‰SACTIVER LE MINT AUTHORITY (Supply fixe)
// ============================================
async function disableMintAuthority() {
  try {
    console.log('\nğŸ”’ DÃ©sactivation du Mint Authority...\n');

    const tokenInfo = JSON.parse(fs.readFileSync('kraken-token-info.json', 'utf-8'));
    const connection = new Connection(clusterApiUrl(tokenInfo.network), 'confirmed');
    const payerKeypair = Keypair.fromSecretKey(
      Uint8Array.from(JSON.parse(fs.readFileSync('wallet.json', 'utf-8')))
    );

    await setAuthority(
      connection,
      payerKeypair,
      new PublicKey(tokenInfo.mintAddress),
      payerKeypair.publicKey,
      AuthorityType.MintTokens,
      null
    );

    console.log('âœ… Mint Authority dÃ©sactivÃ© !');
    console.log('   La supply est maintenant FIXE Ã ', tokenInfo.totalSupply.toLocaleString(), 'tokens');
    console.log('   Plus personne ne peut crÃ©er de nouveaux tokens.');

  } catch (error) {
    console.error('âŒ Erreur:', error.message);
  }
}

// ============================================
// VÃ‰RIFIER LE TOKEN
// ============================================
async function checkToken() {
  try {
    const tokenInfo = JSON.parse(fs.readFileSync('kraken-token-info.json', 'utf-8'));
    const connection = new Connection(clusterApiUrl(tokenInfo.network), 'confirmed');
    
    console.log('\nğŸ” VÃ©rification du token KRAKEN...\n');
    
    const mintInfo = await getMint(connection, new PublicKey(tokenInfo.mintAddress));
    
    console.log('Mint Address:', tokenInfo.mintAddress);
    console.log('Supply:', (Number(mintInfo.supply) / Math.pow(10, mintInfo.decimals)).toLocaleString());
    console.log('Decimals:', mintInfo.decimals);
    console.log('Mint Authority:', mintInfo.mintAuthority?.toString() || 'DÃ‰SACTIVÃ‰');
    console.log('Freeze Authority:', mintInfo.freezeAuthority?.toString() || 'DÃ‰SACTIVÃ‰');
    
  } catch (error) {
    console.error('âŒ Erreur:', error.message);
  }
}

// ============================================
// EXÃ‰CUTION
// ============================================
const command = process.argv[2];

if (command === 'disable-mint') {
  disableMintAuthority();
} else if (command === 'check') {
  checkToken();
} else {
  createKrakenToken();
}

// COMMANDES:
// node kraken-token-creator.js              â†’ CrÃ©er le token
// node kraken-token-creator.js disable-mint â†’ DÃ©sactiver mint authority
// node kraken-token-creator.js check        â†’ VÃ©rifier le token